# Session Notes - 2025-12-04

## Deployed & Working
- **Live URL:** https://mnemo.solamp.workers.dev
- **D1 Database:** `mnemo-cache` (1bf57f2d-d380-475f-8faa-b9f791d14662)
- **R2 Bucket:** `mnemo-files`

## Completed This Session

### Morning Session
1. **GitHub URL Support** - Load any public GitHub repo via API
   - Uses GitHub zipball API (no git binary needed)
   - Works on CF Workers via `loadGitHubRepoViaAPI()`
   - Supports branch refs: `/tree/branch`

2. **TypeScript Config Fixed** - Project references now work
   - Added `composite: true` to all packages
   - Created missing `cf-worker/tsconfig.json`

3. **Unit Tests Added** - 98 tests passing
   - `packages/core/src/repo-loader.test.ts`
   - `packages/core/src/source-loader.test.ts`
   - `packages/mcp-server/src/tools/handlers.test.ts`

4. **Infrastructure Setup**
   - D1 database created with schema
   - R2 bucket created
   - Secrets via `wrangler secret put GEMINI_API_KEY`

### Evening Session
5. **MCP Stdio Transport** - Claude Desktop/Claude Code integration
   - New file: `packages/local/src/stdio.ts`
   - Updated CLI with `stdio` command
   - Created `docs/claude-desktop-setup.md`

6. **Usage Logging & Cost Tracking**
   - Added `UsageLogger` interface to core types
   - Added `GEMINI_PRICING` constants and `calculateCost()` function
   - Implemented `SQLiteUsageLogger` for local server
   - Implemented `D1UsageLogger` for CF Worker
   - `context_stats` now returns usage data with cost estimates

7. **Composite Loading** - Multiple sources into one cache
   - New `sources` array parameter in `context_load`
   - Helper functions: `loadSingleSource()`, `combineLoadedSources()`
   - Can load multiple repos and query them together

8. **Private Repo Support** - GitHub token authentication
   - New `githubToken` parameter in `context_load`
   - Passed to `loadGitHubRepoViaAPI()` as Authorization header

9. **Tests for New Features** - 15 new tests
   - Composite loading tests (7)
   - GitHub token tests (2)
   - Usage logging tests (6)

10. **Live Testing & Fixes**
    - Created `docs/testing-checklist.md` with 12 tests
    - Ran all tests against live deployment
    - Fixed D1 foreign key constraint issue in usage_logs

11. **MCP Config Integration**
    - Added Mnemo to `claude-mcp-config` repo
    - Available via HTTP transport

## Files Changed
- `CLAUDE.md` - Updated with Developer Guidelines MCP section
- `packages/core/src/types.ts` - UsageLogger, pricing constants
- `packages/core/src/repo-loader.ts` - GitHub token support
- `packages/mcp-server/src/tools/schemas.ts` - Composite loading schema
- `packages/mcp-server/src/tools/handlers.ts` - All new features
- `packages/mcp-server/src/tools/handlers.test.ts` - 15 new tests
- `packages/mcp-server/src/server.ts` - UsageLogger config
- `packages/cf-worker/src/index.ts` - D1UsageLogger
- `packages/cf-worker/schema.sql` - Removed FK constraint
- `packages/local/src/index.ts` - SQLiteUsageLogger
- `packages/local/src/cli.ts` - Stdio command
- `packages/local/src/stdio.ts` - NEW: Stdio transport
- `docs/claude-desktop-setup.md` - NEW: Setup guide
- `docs/testing-checklist.md` - NEW: Testing checklist
- `pnpm-workspace.yaml` - NEW: pnpm workspace config

## Roadmap Status
All items from initial roadmap complete:
- [x] MCP stdio transport for Claude Desktop integration
- [x] Wire up usage_logs table (cost tracking)
- [x] Composite loading (multiple sources)
- [x] Private repo support (GitHub token)

## Next Steps (Future Sessions)
- Test Claude Code integration with Mnemo MCP
- Add authentication to CF Worker endpoints
- Add rate limiting
- Support more file types (PDF, markdown)
- Cache refresh functionality
- Publish to npm
